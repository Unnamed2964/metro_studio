# RailMap

基于 `Vue 3 + Vite` 的架空地铁图工具，支持：

- 在真实交通运输底图上做站点/线段编辑
- 导入济南市地铁线网（可选包含在建/规划）
- 支持支线与共线的数据模型
- 手动触发“官方风”自动排版（严格八方向约束 + 惩罚评分）
- 真实地图编辑器、官方风示意图、车辆 HUD 采用工作区阶段化 Tab 单屏切换（阶段一：网络编辑 / 阶段二：版式校核 / 阶段三：车载发布）
- 站点重命名、线路属性编辑（颜色/状态/线型/环线）
- 工程管理器（新建/重命名/复制/删除/检索本地工程）
- 侧边栏采用语义选项卡分组（项目与数据 / 绘制流程 / 对象属性 / 发布导出），在不增删能力前提下提升可达性
- 侧边栏新增“当前上下文”信息条，持续显示编辑模式、对象类型与对象摘要
- 左侧菜单栏支持收起/展开（状态本地持久化）
- 地图多选（Shift/Ctrl/⌘ 框选）与批量拖动/删除
- AI 点站模式（点击新点或已有站点后抓取周边 300m OSM 道路/地域/公共设施/建筑，并调用 BLTCY API 给出 5 个命名候选，鼠标处弹出菜单选择）
- 右键站点菜单支持 AI 翻译英文站名（单站）
- 连续布线模式（从一个点开始，连续点击自动连线；绘制时按距离阈值预览变色并在鼠标旁显示米数）
- 批量站名模板重命名（`{n}` 序号占位）
- 选中多站点后可进行 AI 批量命名（逐站生成 5 个中英文候选并人工点选）
- 一键按规范 AI 重译全图英文站名（调用 BLTCY API，显示实时进度条）
- 绘制流程页支持对“选中站点”执行 AI 英文翻译（支持多选）
- 手动换乘工具（两站绑定/解绑为换乘，适配同名异位站）
- 线段选中高亮（不覆盖线路主色）与删除
- 线段曲线与锚点编辑（新增/拖拽/删除/清空，仅对手动锚点线段启用曲线）
- 真实地图编辑器右键菜单（按点击目标动态出项：空白/站点/线段/锚点）
- 真实地图编辑器比例尺（米/公里）
- 选中线路与方向自动生成车辆 HUD（含换乘标识，长线路自动单弯折返）
- 编辑快捷键（`Delete`、`Ctrl/Cmd+A`、`Esc`）
- 工程本地持久化（IndexedDB）
- 工程文件保存/加载（`.railmap.json`）
- 导出实际走向图 `PNG`、官方风格图 `PNG`、各线路车辆 HUD `ZIP` 打包（内含 PNG）
  - 导出栏车站显示策略仅作用于“实际走向图 PNG”：仅换乘站 / 隐藏所有车站 / 显示所有车站
- 全局日夜模式（主题变量驱动，支持本地持久化）
- 关闭/刷新页面二次确认（防误关）

## 开发运行

```bash
npm install
npm run dev
```

AI 能力前置：

- 配置环境变量 `BLTCY_API_KEY`（前端可用 `VITE_BLTCY_API_KEY`）
- 默认模型为 `claude-haiku-4-5-20251001`

## 构建

```bash
npm run build
```

## 代码结构（模块化拆分）

- `src/workers/layout/`：自动排版算法分层（主流程、力学、硬约束、标签、评分、通用几何）。
- `src/stores/project/`：`projectStore` 的 helpers 与 actions 拆分目录。
- `src/lib/ai/`：BLTCY 命名候选生成（结构化 JSON 输出校验与回退）。
- `src/lib/osm/jinan/`：济南 OSM 导入分层实现（常量/查询、命名、状态、拓扑、导入入口）。
- `src/lib/osm/nearbyStationNamingContext.js`：站点周边 300m 命名语义上下文提取（道路/地域/设施/建筑）。
- `src/components/map-editor/`：地图编辑器脚本中的纯函数与常量拆分目录。

## 关键实现说明

- OSM 导入:
  - 使用 Overpass API 查询济南市 (`relation 3486449`) 区域内 `subway/light_rail` 路由关系。
  - 在建判定: `route=construction` 或 `state=construction` 或 `construction=subway|light_rail`。
  - 规划判定: `state=proposed` 或 `proposed=subway|light_rail`。
  - 线路命名优先取 `ref` 并规范化（如 `3` -> `3号线`），自动剥离 `：起点 → 终点` 这类方向后缀，避免导入方向描述名。
  - 导入操作不会覆盖当前工程：会先保存当前工程，再自动新建“`当前工程名 (OSM导入)`”并将导入结果写入该新工程。
  - 勾选“包含在建/规划”时，会额外导入未挂到线路 relation 的独立地铁站点节点（例如仅有 `construction:*`/`proposed:*` 标记的车站）。
  - 环线识别：`roundtrip/circular/route/name` 信号综合判断，环线名自动去除“起终点”后缀显示（覆盖破折号、括号等常见写法）。
- 编辑交互:
  - 真实地图底图采用 OSM 标准瓦片（`tile.openstreetmap.org`，MapLibre raster source）。
  - 地图支持站点单选/多选、框选、批量拖动，支持线段点击选中与高亮。
  - 阶段一网络编辑中的站点文字标注默认显示中英文双行（若英文为空则仅显示中文）。
  - 新增 AI 点站模式：空白点击后先落站，点击已有站点则直接复命名；统一抓取周边 `300m` OSM 语义要素（道路/地域/公共设施/建筑），调用 BLTCY API（默认 `claude-haiku-4-5-20251001`）返回 `5` 个候选站名，并在鼠标处弹出可点击菜单应用中英文站名。
  - 对象属性页新增“按规范重译全图英文”按钮：分批调用 BLTCY API，并通过进度条显示 `done/total/percent`。
  - 支持手动换乘关系：多选两个站点后可在工具栏直接“设为换乘/取消换乘”，用于将同名异位站按换乘处理。
  - 新增连续布线模式：首击设置起点，后续每次点击自动与上一点连线并将当前点作为下一段起点；点击空白会先落站再连线。
  - 连续布线预览支持距离阈值着色：`<500m` 红色、`>2000m` 紫色、其余使用当前线路原色；并在鼠标旁实时显示当前段距离（米）。
  - 线段支持曲线渲染与锚点编辑：锚点可点击选中、拖拽调整，支持右键在线段加锚点、删除锚点、清空锚点；导入线段默认保持原始折线，不做全局平滑。
  - 线段渲染会按端点自动校正 `waypoints` 点序方向（必要时自动反转），避免同站间合并后出现折线跳变。
  - 地图视角锁定正北并禁用旋转/俯仰，避免 `Ctrl` 组合拖拽与编辑手势冲突。
  - 地图右键菜单按点击对象动态显示：空白处（加站/AI加站/清空选择）、站点（AI命名/重命名/删除）、线段（加锚点/删线段/清空锚点）、锚点（删锚点/加锚点/清空所属线段锚点）；并在鼠标位置附近按实际菜单尺寸自动贴边。
  - 站点右键菜单新增“AI翻译英文”，可对单个站点直接重译英文名。
  - 选中线段后，若该线段存在中间 `waypoints`（含导入线段），会显示可编辑锚点。
- 工具栏采用语义分组选项卡（项目与数据 / 绘制流程 / 对象属性 / 发布导出），覆盖工程管理器、OSM 导入、编辑模式与排版控制、站点/线段/线路属性编辑与导出控制；工程与导出能力固定放在工具栏，不放入右键菜单。
  - 绘制流程页新增“AI翻译选中站英文”快捷入口，支持对当前选中 1~N 个站点执行英文重译。
  - 绘制流程页仅承载模式、选择与排版流程控制；对象属性页统一承载站点、线段、线路编辑。
  - 绘制模式包含：选择/拖拽、点站、AI点站、拉线、连续布线。
  - 多站点对象属性支持 AI 批量命名流程：逐站 5 选 1，并显示进度。
  - 全图英文重译使用 `chat/completions` + `response_format(json_schema)` 约束输出，降低翻译过程中的格式漂移。
  - 工具栏支持收起/展开，便于为主画布腾出横向空间。
  - 编辑页提供 `geoSeedScale` 动态滑块，用于调节自动排版的地理种子展开尺度。
  - 快捷键：`Delete/Backspace` 删除当前选中对象，`Ctrl/Cmd+A` 全选站点，`Esc` 清空选择并取消待连接起点。
- UI 主题:
  - 全局样式采用统一主题变量（侧边栏 + 三视图容器风格统一）。
  - 支持日间/夜间模式切换，并将用户选择持久化到 `localStorage`。
- 边界过滤:
  - 使用内置济南行政边界 GeoJSON（来源于 OSM/Nominatim 的 `R3486449`）做点位过滤。
- 自动排版:
  - 在 Web Worker 执行，避免阻塞主线程。
  - 地理锚定优先：保持原地理骨架，不做拓扑主导重排。
  - 支持通过工具栏参数滑块动态传入 `geoSeedScale`，并随工程持久化。
  - 通过严格八方向规整（最终采用误差收敛式硬约束回投，不放行近似角度）、交汇扇出、交叉排斥、边最小长度硬约束、站点最小间距硬分离（相邻站/换乘站自适应加严）与位移上限约束提升可读性。
  - Worker 返回 `layoutMeta`（站名锚点、边方向）供预览与导出复用。
  - 评分项包含角度偏差、长度偏差、转折惩罚、短折线惩罚、交叉、站点重叠、地理偏移、标签重叠。
- 示意图渲染与导出:
  - 连线使用八向圆角折线，支持共线偏移、线路状态透明度分层、线型（实线/虚线/点线/双线/双虚线/双方点线）。
  - 预览与导出共享统一渲染模型，保证界面与文件视觉一致。
  - 导出拆分为“实际走向图 PNG（非镜像）”与“官方风格图 PNG（Y 轴镜像）”。
  - “实际走向图 PNG”基于真实地图编辑器导出，导出时自动定位全网范围并隐藏站名（导出后恢复当前视角）。
  - 示意图视图支持滚轮缩放、中键平移，并自适应铺满视图窗口。
- 车辆 HUD:
  - 选择线路后自动抽取主路径并生成方向候选（开往终点/反向；环线正反向）。
  - HUD 站序自动按方向展开，渲染蓝色主线、空心站点、段间双箭头与中英站名。
  - 顶部使用济南地铁风格头部结构：Logo 与品牌、线路牌、中部“下一站”、右侧终点信息。
  - 换乘站自动标识（主符号 + 徽标 + 其他线路颜色点），并支持识别手动换乘关系带来的跨站换乘。
  - 环线线路在 HUD 中按双层闭合轨道渲染（上下两层，左右端首尾连接）。
  - 当站数超过约 `30` 站自动折返为两排，并使用单次圆角弯连接；未折返时宽度按站数自适应，且纵向高度压缩。
  - HUD 视图支持滚轮缩放与中键平移。
  - 支持按所有线路与方向批量导出 HUD 并 ZIP 打包。
- 稳定性:
  - IndexedDB 入库前执行可序列化投影，避免响应式对象导致 `DataCloneError`。
  - Overpass 导入采用代理优先 + 公网回退 + 超时控制，降低单端点故障影响。

## 数据存储

- IndexedDB:
  - `projects`: 工程对象
  - `meta`: 最近工程指针
- 工程文件格式:
  - JSON，包含 `projectVersion`，用于后续迁移兼容。
