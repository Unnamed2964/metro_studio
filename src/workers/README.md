# workers 目录说明

该目录存放 Web Worker 计算任务。

- `layoutWorker.js`
  - 自动排版核心算法
  - 地理锚定优先的力导向迭代（保留原地理形态，不做拓扑重排）
  - 每次排版均从 `lngLat` 重建初始坐标，避免连续多次排版导致示意图漂移
  - 地理初始坐标系放大（默认 `geoSeedScale=6`，支持由 UI 动态传入），提高空间展开度
  - 严格八方向约束（最终阶段采用误差收敛式硬约束回投，不放行近似角度）+ 交汇扇出 + 交叉排斥
  - 最终边最小长度硬约束（`length >= minEdgeLength`）防止相邻站过近
  - 最终站点最小间距硬分离（迭代收敛，自适应提高相邻站/换乘站阈值），避免上下/平行走廊近贴
  - 线路长走廊直线化（连续、非换乘/非分叉站段按端点连线投影，抑制阶梯抖动）
  - 位移上限约束（限制偏离真实地理骨架）
  - 自动标签布局（返回 `layoutMeta.stationLabels`）
  - 标签候选支持近/中/远分层与居中锚点优先（端点站优先居中），在避线前提下减少左右偏移感
  - 站点局部走向感知：竖向走向时先在 `middle` 候选集内求最优，仅在不可用时回退左右锚点，减少竖线右偏文字
  - 标签避线安全距约束（与线段保持最小间距，避免文字贴线；对本站相邻边采用端点忽略半径，保留站点附近可用锚点）
  - 标签选位采用两阶段：先执行“避线硬筛选”（不碰线且满足安全距），无解时才退回软评分兜底
  - 标签后处理松弛：对已选标签执行迭代小步位移（标签-标签/标签-线段/标签-站点三类约束），直到碰撞收敛
  - 标签包围盒宽度估计按 CJK/Latin 混合字符宽度计算，并优先做横向分离，降低相邻站名并排重叠概率
  - 评分函数（角度、长度、转折、短折线、重叠、交叉、地理偏差、标签冲突）
  - 返回更新后的站点布局、评分明细与 `layoutMeta`

目的：

- 将重计算从主线程移出，保持编辑交互流畅。
